<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Encrypt Text ‚Üí Image</title>
  <style>
    body {font-family: 'Segoe UI', Tahoma, sans-serif; background: linear-gradient(135deg,#667eea,#764ba2); min-height:100vh; margin:0; display:flex; justify-content:center; align-items:center; padding:20px;}
    .container {background:white; padding:35px; border-radius:20px; width:100%; max-width:800px; box-shadow:0 20px 60px rgba(0,0,0,0.3);}    
    h1 {text-align:center; color:#667eea; margin-bottom:25px;}
    .back {display:inline-block; margin-bottom:20px; text-decoration:none; color:#667eea; font-weight:600;}
    .input-group {margin-bottom:20px;}
    label {display:block; font-weight:600; margin-bottom:8px; color:#333;}
    textarea {width:100%; min-height:150px; resize:vertical; padding:12px; border:2px solid #e0e0e0; border-radius:8px; font-family:inherit;}
    textarea:focus {outline:none; border-color:#667eea;}
    .radio-group {display:flex; gap:20px; margin-bottom:10px;}
    button {width:100%; padding:15px; font-size:1.15em; border:none; border-radius:12px; font-weight:700; cursor:pointer; background:linear-gradient(135deg,#667eea,#764ba2); color:white; box-shadow:0 10px 30px rgba(102,126,234,0.4); transition:.3s;}
    button:hover {transform:translateY(-3px);}
    .result {display:none; margin-top:30px; background:#f5f5f5; border-radius:12px; padding:20px;}
    .result.show {display:block;}
    .key-display {position:relative; background:white; padding:15px; border-radius:8px; border:2px solid #667eea; font-family:'Courier New',monospace; word-break:break-all; overflow-x:auto;}
    .image-preview {margin-top:15px; text-align:center;}
  .image-preview {position:relative;}
  .image-preview img {width:100%; max-width:none; border:3px solid #667eea; border-radius:18px; box-shadow:0 8px 30px rgba(102,126,234,.35);}
  .actions-row {display:flex; flex-wrap:wrap; gap:12px; margin-top:18px;}
  .btn-action {flex:1 1 180px; padding:12px 18px; background:#667eea; color:#fff; border:none; border-radius:12px; font-weight:600; cursor:pointer; transition:.25s; text-align:center;}
  .btn-action:hover {background:#5568d9;}
  .btn-secondary {background:#fff; color:#667eea; border:2px solid #667eea;}
  .btn-secondary:hover {background:#667eea; color:#fff;}
  .copy-feedback {font-size:.85em; color:#2f8f2f; margin-top:6px; display:none;}
    .loading {display:none; text-align:center; margin-top:20px;}
    .loading.show {display:block;}
    .spinner {border:4px solid #f3f3f3; border-top:4px solid #667eea; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:0 auto;}
    @keyframes spin {to {transform:rotate(360deg);}}

    /* Drag & Drop styles */
    .file-input-hidden {display:none;}
    .drop-zone {border:2px dashed #a9b3ff; border-radius:12px; background:#fafbff; padding:22px; text-align:center; color:#555; transition:all .25s ease;}
    .drop-zone:hover {border-color:#667eea; box-shadow:0 6px 20px rgba(102,126,234,.2);}
    .drop-zone.dragover {background:#eef0ff; border-color:#667eea;}
    .drop-zone .title {font-weight:700; color:#667eea; margin-bottom:8px;}
    .drop-zone .hint {font-size:.95em; color:#666;}
    .drop-zone .actions {margin-top:12px;}
    .btn-link {display:inline-block; padding:10px 16px; border-radius:10px; background:white; border:2px solid #667eea; color:#667eea; font-weight:700; cursor:pointer; text-decoration:none;}
    .btn-link:hover {background:#667eea; color:white;}
    .file-meta {margin-top:10px; font-size:.95em; color:#333;}
    .file-preview {margin-top:10px; background:white; border:1px solid #e3e3ff; border-radius:8px; padding:10px; max-height:160px; overflow:auto; font-family:'Courier New',monospace; white-space:pre-wrap;}
  </style>
</head>
<body>
  <div class="container">
    <a href="/" class="back">‚Üê Back</a>
    <h1>üîí Encrypt Text to Image</h1>
    <form id="encrypt-form">
      <div class="input-group">
        <label>Input Method:</label>
        <div class="radio-group">
          <label><input type="radio" name="input-method" value="text" checked onchange="toggleInput()" /> Direct Text</label>
          <label><input type="radio" name="input-method" value="file" onchange="toggleInput()" /> Upload Text File (.txt)</label>
        </div>
      </div>
      <div class="input-group" id="text-input-group">
        <label for="text-input">Enter Text:</label>
        <textarea id="text-input" name="text" placeholder="Type your message here..."></textarea>
      </div>
      <div class="input-group" id="file-input-group" style="display:none;">
        <label>Upload .txt File:</label>
        <input class="file-input-hidden" type="file" id="file-input" accept=".txt" />
        <div id="drop-zone" class="drop-zone" tabindex="0" aria-label="Drag and drop a .txt file here or browse">
          <div class="title">Drag & Drop your .txt file</div>
          <div class="hint">Only plain text (.txt). Max 1 file.</div>
          <div class="actions" role="group">
            <a class="btn-link" href="#" onclick="document.getElementById('file-input').click(); return false;">Browse Files</a>
          </div>
          <div id="file-meta" class="file-meta" style="display:none;"></div>
          <pre id="file-preview" class="file-preview" style="display:none;"></pre>
        </div>
      </div>
      <button type="submit">Encrypt ‚Üí Image</button>
    </form>
    <div class="loading" id="encrypt-loading">
      <div class="spinner"></div>
      <p>Encrypting...</p>
    </div>
    <div class="result" id="encrypt-result">
      <h3>Result:</h3>
      <div class="key-display" id="key-container">
        <span id="encryption-key"></span>
      </div>
      <div id="copy-feedback" class="copy-feedback">Key copied to clipboard ‚úî</div>
      <div class="actions-row" id="key-actions">
        <button type="button" class="btn-action btn-secondary" id="copy-btn" onclick="copyKey()">Copy Key</button>
      </div>
      <div class="actions-row" id="image-actions">
        <button type="button" class="btn-action" id="download-btn" onclick="downloadImage()">Download Image</button>
      </div>
      <div class="actions-row" id="home-actions">
        <button type="button" class="btn-action btn-secondary" onclick="goHome()">Back to Home</button>
      </div>
    </div>
  </div>
<script>
function toggleInput(){
  const inputMethod = document.querySelector('input[name="input-method"]:checked').value;
  const textGroup = document.getElementById('text-input-group');
  const fileGroup = document.getElementById('file-input-group');
  if(inputMethod==='text'){
    textGroup.style.display='block';
    fileGroup.style.display='none';
  } else {
    textGroup.style.display='none';
    fileGroup.style.display='block';
  }
}

let selectedFile = null;

const fileInput = document.getElementById('file-input');
const dropZone = document.getElementById('drop-zone');
const fileMeta = document.getElementById('file-meta');
const filePreview = document.getElementById('file-preview');

function clearFileUI(){
  fileMeta.style.display = 'none';
  filePreview.style.display = 'none';
  fileMeta.textContent = '';
  filePreview.textContent = '';
}

function isTxt(name){
  return name && name.toLowerCase().endsWith('.txt');
}

async function setSelectedFile(file){
  selectedFile = file;
  // Reflect into the hidden input so form behaves consistently
  try{
    const dt = new DataTransfer();
    dt.items.add(file);
    fileInput.files = dt.files;
  }catch(_){/* not critical */}
  // Update UI
  fileMeta.textContent = `${file.name} ‚Ä¢ ${(file.size/1024).toFixed(1)} KB`;
  fileMeta.style.display = 'block';
  // Preview first ~1000 chars
  try{
    const text = await file.text();
    const snippet = text.slice(0, 1000);
    filePreview.textContent = snippet;
    filePreview.style.display = snippet ? 'block' : 'none';
  }catch(_){
    filePreview.style.display = 'none';
  }
}

fileInput.addEventListener('change', async (e)=>{
  clearFileUI();
  const f = e.target.files && e.target.files[0];
  if(!f) { selectedFile=null; return; }
  if(!isTxt(f.name)) { alert('Only .txt files are allowed.'); fileInput.value=''; selectedFile=null; return; }
  await setSelectedFile(f);
});

['dragenter','dragover'].forEach(evt=>{
  dropZone.addEventListener(evt, (e)=>{ e.preventDefault(); e.stopPropagation(); dropZone.classList.add('dragover'); });
});
['dragleave','dragend','drop'].forEach(evt=>{
  dropZone.addEventListener(evt, (e)=>{ if(evt!=='drop'){ dropZone.classList.remove('dragover'); } });
});
dropZone.addEventListener('drop', async (e)=>{
  e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('dragover');
  clearFileUI();
  const f = e.dataTransfer.files && e.dataTransfer.files[0];
  if(!f){ return; }
  if(!isTxt(f.name)) { alert('Only .txt files are allowed.'); return; }
  await setSelectedFile(f);
});

document.getElementById('encrypt-form').addEventListener('submit', handleEncryptSubmit);

async function handleEncryptSubmit(e){
  e.preventDefault();
  const loading = document.getElementById('encrypt-loading');
  const result = document.getElementById('encrypt-result');
  loading.classList.add('show');
  result.classList.remove('show');
  const formData = new FormData();
  const inputMethod = document.querySelector('input[name="input-method"]:checked').value;
  if(inputMethod==='text'){
    formData.append('text', document.getElementById('text-input').value);
    formData.append('use_file','false');
  } else {
    if(!selectedFile){
      loading.classList.remove('show');
      alert('Please select a .txt file to upload.');
      return;
    }
    formData.append('uploaded_file', selectedFile);
    formData.append('use_file','true');
  }
  try{
    const response = await fetch('/encrypt',{method:'POST', body:formData});
    const data = await response.json();
    loading.classList.remove('show');
    if(data.success){
      document.getElementById('encryption-key').textContent = data.key;
      const copyBtn = document.getElementById('copy-btn');
      const dlBtn = document.getElementById('download-btn');
      if(copyBtn){ copyBtn.disabled = false; copyBtn.textContent = 'Copy Key'; }
      if(dlBtn){ dlBtn.disabled = false; dlBtn.textContent = 'Download Image'; }
      result.classList.add('show');
    } else { alert('Error: '+data.error); }
  }catch(err){
    loading.classList.remove('show');
    alert('Error connecting to server: '+err);
  }
}

// Copy key to clipboard
function copyKey(){
  const keyEl = document.getElementById('encryption-key');
  const text = keyEl.textContent.trim();
  if(!text){return;}
  const btn = document.getElementById('copy-btn');
  navigator.clipboard.writeText(text).then(()=>{
    const original = btn.textContent;
    btn.textContent = 'Copied!';
    btn.disabled = true;
    setTimeout(()=>{ btn.textContent = original; btn.disabled = false; }, 2000);
  }).catch(()=>{alert('Failed to copy key.');});
}

// Download image
function downloadImage(){
  const btn = document.getElementById('download-btn');
  const urlWithBuster = '/get-image?t=' + new Date().getTime();
  fetch(urlWithBuster)
    .then(r=>{
      if(!r.ok) throw new Error('Image not ready');
      return r.blob();
    })
    .then(blob=>{
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'encrypted_image.png';
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 3000);
      const original = btn.textContent;
      btn.textContent = 'Downloaded!';
      btn.disabled = true;
      setTimeout(()=>{ btn.textContent = original; btn.disabled = false; }, 2000);
    })
    .catch(()=>alert('Failed to download image. Make sure you encrypted text first.'));
}

function goHome(){
  window.location.href = '/';
}
</script>
</body>
</html>